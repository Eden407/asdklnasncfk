dup() {
  # Number of recent commands to capture; adjust as needed.
  local num=10
  # Capture the last N commands from history (excluding the current .dup command)
  local commands
  commands=$(fc -l -$((num+1)) -1 | sed 's/^[[:space:]]*[0-9]\+[[:space:]]*//')
  commands=$(echo "$commands" | grep -v '^\.dup')

  # Build the AppleScript commands block.
  # Each command is converted to a write text command.
  local script_cmds=""
  while IFS= read -r line; do
    # Escape any embedded double quotes.
    local escaped_line
    escaped_line=$(printf '%s' "$line" | sed 's/"/\\"/g')
    script_cmds="${script_cmds}
        write text \"${escaped_line}\"
    "
  done <<< "$commands"

  osascript <<EOF
tell application "iTerm2"
  tell current window
    tell current tab
      tell current session
        -- Split the current session vertically; this returns the new session.
        set newSession to (split vertically with default profile)
      end tell
      delay 1
      tell newSession
$script_cmds
      end tell
    end tell
  end tell
end tell
EOF
}
