import requests
import re
import os

def main():
    # Explain how to get the App ID
    print("Welcome!")
    print("This script will help you retrieve the Bundle ID for an iOS app.")
    print("\nStep 1: Enter the app name below.")
    print("Step 2: Open your browser and search for \"<App Name> app store ios\" (for example, 'Instagram app store ios').")
    print("Step 3: Click on the first search result. In the URL, you will see something like:")
    print("        https://apps.apple.com/us/app/instagram/id389801252?mt=8")
    print("        Note that the app ID is the numeric part following 'id' (in this example, 389801252).")
    print("Step 4: Paste the full URL or just the numeric App ID when prompted.\n")
    
    # Get the app name (for user context only)
    app_name = input("Enter the app name: ").strip()
    
    # Prompt the user for the App Store URL or the App ID
    user_input = input("\nPaste the App Store URL (or just the App ID): ").strip()
    
    # Extract the numeric app ID from the user input.
    # This regex finds a sequence of 8 or more digits.
    id_match = re.search(r'\b(\d{8,})\b', user_input)
    if not id_match:
        print("Could not find a numeric App ID in your input. Please ensure you copy a valid URL or App ID.")
        return
    
    app_id = id_match.group(1)
    print(f"\nExtracted App ID: {app_id}\n")
    
    # Construct the lookup URL using the extracted app ID.
    lookup_url = f"https://itunes.apple.com/lookup?id={app_id}"
    
    # Request app details from the iTunes Lookup API.
    response = requests.get(lookup_url)
    if response.status_code != 200:
        print("Error: Failed to retrieve data from the iTunes API.")
        return
    
    # Save the response to a temporary file.
    temp_filename = "appinfo.txt"
    try:
        with open(temp_filename, "w", encoding="utf-8") as file:
            file.write(response.text)
    except Exception as e:
        print("Error writing to temporary file:", e)
        return
    
    # Read the file content.
    try:
        with open(temp_filename, "r", encoding="utf-8") as file:
            content = file.read()
    except Exception as e:
        print("Error reading from temporary file:", e)
        return
    
    # Use regex to extract the bundle ID from the JSON content.
    bundle_match = re.search(r'"bundleId"\s*:\s*"([^"]+)"', content)
    if bundle_match:
        bundle_id = bundle_match.group(1)
        print("Bundle ID:", bundle_id)
    else:
        print("Could not locate the Bundle ID in the retrieved data.")
    
    # Delete the temporary file.
    try:
        os.remove(temp_filename)
    except Exception as e:
        print("Error deleting temporary file:", e)

if __name__ == "__main__":
    main()
